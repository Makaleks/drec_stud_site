{% extends 'core/base.html' %}
{% load utils_extra_filters %}
{% block head_extras %}
<link type='text/css' rel='stylesheet' href='https://unpkg.com/tippy.js@1.2.0/dist/tippy.css' /> {% endblock %}
{% block content %}
    <section class='card'>
        <h2 class='lightblue'>Заказ стиральной машины</h2>
        <div>
            <p>
                <b>Что&nbsp;значат&nbsp;цвета?</b>
            </p>
            <p class='card-maintext'>
                <span class='preview'></span> - Этот интервал можно выбирать<br />
                <span class='preview ended'></span> - Этот интервал уже нельзя выбирать<br />
                <span class='preview selected'></span> - Этот интервал был кем-то выбран<br />
                <span class='preview choisen'></span> - Этот интервал был выбран вами<br />
                <span class='preview started'></span> - Этот интервал можно выбирать, но он уже идет и прошло меньше половины(?)
            </p>
            <p><b>Чтоб выбрать или отменить выбор интервала нажми на него</b></p>
        </div>
    </section>
    <form action='' method='post' id='washing'>
        {% csrf_token %}
        <div class='card'>
            <h2>Понедельник 04.09</h2>
            <table class='table_aside'>
                <tr>
                    <th>Время</th>
                </tr>
                <tr>
                    <td>9:00</td>
                </tr>
                <tr>
                    <td>9:00</td>
                </tr>
                <tr>
                    <td>9:30</td>
                </tr>
                <tr>
                    <td>10:00</td>
                </tr>
            </table>
            <table class='table_main'>
                <tr>
                    <th>Машина №1<br /><small>(10 руб.)</small></th>
                    <th>Машина №2<br /><small>(10 руб.)</small></th>
                    <th>Машина №3<br /><small>(10 руб.)</small></th>
                    <th>Машина №4<br /><small>(10 руб.)</small></th>
                    <th>Машина №5<br /><small>(10 руб.)</small></th>
                </tr>
                <tr>
                    <td class='ended'></td>
                    <td class='ended'></td>
                    <td class='ended'></td>
                    <td class='ended'></td>
                    <td class='ended selected'></td>
                </tr>
                <tr>
                    <td class='started selected'></td>
                    <td class='started'>
                        <label>
                  <input type='checkbox' data-price='10' class='hidden' />
                  <span>V</span>
                </label>
                    </td>
                    <td class='started selected'>
                        <label class='userinfo' for='modal_userinfo_check' onclick='showuserinfo("Иванов Иван Иванович", "39333502", "+79777777777", "email@example.com");' title='Посмотреть инфо о заказавшем(-ей)'></label>
                    </td>
                    <td class='started'>
                        <label>
                  <input type='checkbox' data-price='10' class='hidden' />
                  <span>V</span>
                </label>
                    </td>
                    <td class='started selected'></td>
                </tr>
                <tr>
                    <td>
                        <label>
                  <input type='checkbox' data-price='10' class='hidden' />
                  <span>V</span>
                </label>
                    </td>
                    <td>
                        <label>
                  <input type='checkbox' data-price='10' class='hidden' />
                  <span>V</span>
                </label>
                    </td>
                    <td class='choisen'></td>
                    <td>
                        <label>
                  <input type='checkbox' data-price='10' class='hidden' />
                  <span>V</span>
                </label>
                    </td>
                    <td>
                        <label>
                  <input type='checkbox' data-price='10' class='hidden' />
                  <span>V</span>
                </label>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label>
                  <input type='checkbox' data-price='10' class='hidden' />
                  <span>V</span>
                </label>
                    </td>
                    <td>
                        <label>
                  <input type='checkbox' data-price='10' class='hidden' />
                  <span>V</span>
                </label>
                    </td>
                    <td>
                        <label>
                  <input type='checkbox' data-price='10' class='hidden' />
                  <span>V</span>
                </label>
                    </td>
                    <td>
                        <label>
                  <input type='checkbox' data-price='10' class='hidden' />
                  <span>V</span>
                </label>
                    </td>
                    <td>
                        <label>
                  <input type='checkbox' data-price='10' class='hidden' />
                  <span>V</span>
                </label>
                    </td>
                </tr>
            </table>
        </div>
        {% with time_list=service.get_timetable_list %}
        {% with item_info=service.get_item_info %}
            {% for day in time_list %}
                <div class='card'>
                    <h2>{{ day.day }}</h2>
                    <table class='table_aside'>
                        <tr>
                            <th>Время</th>
                        </tr>
                        {% for t in day.time_layout %}
                            <tr>{#|time:'H:M'#}
                                <td>{{ t.time_start }}</td>
                            </tr>
                        {% endfor %}
                    </table>
                    {% for machine,m_value in day.items.items %}
                        <table class='table_main'>
                            <tr>
                                <th>{{ machine }}<br /><small>({{ item_info.price|by_key:machine }} руб.)</small></th>
                            </tr>
                            {% for cell in m_value.time %}
                            <tr style='height: calc(52px*{{ m_value.rowspan }} - 2px);'>
                                    <td >
                                        <label>
                                            <input type='checkbox' name='{{ machine }}&&{{ cell.time_start }}&&{{ cell.time_end }}' data-price='{{ item_info.price|by_key:machine }}' class='hidden' />
                                            <span>V</span>
                                        </label>
                                    </td>
                                </tr>
                            {% endfor %}
                        </table>
                    {% endfor %}
                </div>
            {% endfor %}
        {% endwith %}
        {% endwith %}
        <div class='card hidden' id='preresult'>
            <p id='pretext'></p>
        </div>
        <div class='card' id='finalresult'>
            <p id='finaltext'>
                Вы ничего не выбрали
            </p>
            <input id='finalcancel' type='button' value='Сбросить' />
            <input id='finalsubmit' type='submit' value='Подтверждаю' />
        </div>
    </form>
{% endblock %}
{% block body_extras %}
    <script src='https://unpkg.com/tippy.js@1.2.0/dist/tippy.min.js'></script>
    <script>
        window.addEventListener('load', function() {
            var preview = document.querySelector('#pretext'),
                finalview = document.querySelector('#finaltext'),
                currentprice = 0,
                price = 0,
                addwash = 0,
                removewash = 0,
                inputs = document.querySelector('#washing').querySelectorAll('input[type=checkbox]');
    
            for (var item of inputs) {
                item.addEventListener('change', function() {
                    price = parseInt(this.getAttribute('data-price'), 10);
                    if (this.checked) {
                        if (price > 0) {
                            addwash++;
                        } else {
                            removewash++;
                        }
                        currentprice += price;
                    } else {
                        if (price > 0) {
                            addwash--;
                        } else {
                            removewash--;
                        }
                        currentprice -= price;
                    }
                    if (addwash > 0) {
                        preview.innerHTML = ((addwash > 0) ? ('Заказано: ' + addwash) : '') + ' Итого: ' + currentprice + 'руб. <a href="#finaltext">К оплате</a>';
                        document.querySelector('#preresult').classList.remove('hidden');
                        finalview.innerHTML = 'Вы выбрали ' + addwash + ' интервалов<br />Итого ' + ((currentprice > 0) ? ('нужно оплатить ' + currentprice) : ('вам вернут ' + (-currentprice))) + ' руб.';
                    } else {
                        finalview.innerHTML = 'Вы ничего не выбрали';
                        document.querySelector('#preresult').classList.add('hidden');
                    }
                });
            }
            document.querySelector('#finalcancel').addEventListener('click', function() {
                addwash = 0;
                removewash = 0;
                currentprice = 0;
                for (var item of inputs) {
                    item.checked = false;
                };
                finalview.innerHTML = 'Вы ничего не выбрали';
                document.querySelector('#preresult').classList.add('hidden');
            });
        });
    
        function showuserinfo(name, vkid, number, email) {
            var username = document.querySelector('#userinfo_name'),
                uservkid = document.querySelector('#userinfo_vkid'),
                usernumber = document.querySelector('#userinfo_number'),
                useremail = document.querySelector('#userinfo_email');
            usernumber.classList.add('hidden');
            uservkid.classList.add('hidden');
            useremail.classList.add('hidden');
            username.innerText = name;
            if (number !== null) {
                usernumber.innerText = 'Позвонить: ' + number;
                usernumber.href = 'tel:' + number;
                usernumber.classList.remove('hidden');
            }
            if (vkid !== null) {
                uservkid.href = 'https://vk.me/id' + vkid;
                uservkid.classList.remove('hidden');
            }
            if (email !== null) {
                useremail.innerText = 'Написать: ' + email;
                useremail.href = 'mailto:' + email;
                useremail.classList.remove('hidden');
            }
        };
        tippy('.userinfo');
    
    </script>
{% endblock %}
